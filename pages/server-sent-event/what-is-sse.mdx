## Server Sent Event

## 참고자료

- [Using Server Sent events (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events)

<br/>



## Polling, Long Polling, HTTP Streaming

### Polling

![](./img/what-is-sse/polling.png)

서버는 요청을 기다리고 있다가 요청이 왔을 때 응답을 해주는 역할만을 수행합니다. <br/>

클라이언트는 일정 간격마다 한번 씩 Request 를 합니다.<br/>

클라이언트가 짧은 주기마다 서버에 요청을 요청하면 서버에 부담이 가고, 서버에 요청을 하는 주기를 길게 잡으면 실시간성이 떨어집니다. <br/>

<br/>



### Long Polling

![](./img/what-is-sse/long-polling.png)

클라이언트는 서버에 request 를 합니다. 서버는 미리 지정한 timeout 기간 마다 timeout 기간 내에 데이터 또는 이벤트를 클라이언트에 전달합니다. 서버는 데이터가 준비되지 않았거나 이벤트가 없더라도 timeout 이 지났다면 데이터가 없다거나 이벤트가 없다는 내용을 response 로 전달해줍니다.<br/>

클라이언트는 응답을 받은 후 대기 없이 바로 다시 request 를 합니다.<br/>

만약 클라이언트에게 제공할 데이터/이벤트가 여러개일 경우 각각의 데이터/이벤트를 단건으로 여러개의 long poll 요청에 나눠서 전달해줍니다.<br/>

구현의 난이도가 낮으며, 이벤트, 데이터가 있을 때마다 데이터를 돌려주는 방식이기에 Polling 방식보다는 실시간성이 조금은 높습니다.<br/>

하지만 서버 측에서는 TCP/IP 연결을 오랫동안 열어둔 상태로 대기해야 한다는 점, Connection Pool 관리 문제가 있고 클라이언트 측에서는 브라우저, gateway 등의 timeout 을 고려해서 서버의 long poll 대기 시간을 정해야 하기에 운영환경에 따라 재배포 이슈가 생기게 됩니다.<br/>

<br/>



### HTTP Streaming

![](./img/what-is-sse/http-streaming.png)

클라이언트는 최초 1회 Server 에 요청을 보냅니다.<br/>

서버는 전달할 데이터가 있거나 이벤트가 있을 때마다 응답을 전달해줍니다. 클라이언트의 request 는 닫지 않고 계속해서 이벤트, 데이터가 생길때마다 클라이언트 측에 전달해줍니다.<br/>

서버 입장에서는 응답을 내려 줄 때 Content-Length 를 내려주기 곤란한 경우가 있습니다. 예를 들면 컨텐츠의 길이를 알 수 없이 계속 해서 생기는 경우가 있기도 하고 길이 자체를 미리 알 수 없는 경우입니다.<br/>

이런 경우 HTTP Streaming 을 아래와 같이 구현합니다.

Transfer-Encoding 헤더

- Transfer-Encoding: chunked 를 헤더에 추가해서 chunk 단위로 데이터를 나눠서 보냄을 명시합니다.
- 클라이언트는 비어있는 chunk 를 전달받기 전까지는 계속해서 값을 읽음 
  - 예를 들어 개행문자가 두번 이어질 경우 데이터의 끝임을 클라이언트 측에서 인지합니다.
- HTTP/1.1 이상에서만 사용가능합니다.

EOF

- 서버의 연결 종료를 양방향 간에 파악하는 방법입니다.

- Connection: close 를 헤더에 추가합니다.
- 서버가 연결을 종료하겠다는 메시지를 보내기 전까지는 들어오는 값을 읽습니다.

<br/>



## Server Sent Event 



## 데이터 형식

참고 : [Using Server Sent events (MDN)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events#fields)

```plain
id:0 
event:vote 
:election-event-k
data:김철수

id:1 
event:vote 
:election-event-k
data:고영희

```



id

- 클라이언트에서는 이벤트의 id 를 저장하고 있고 연결이 끊기거나 재접속을 할 때 `Last-Event-ID` 헤더에 이벤트의 id 를 첨부해서 가장 마지막으로 받은 이벤트가 무엇인지 전달합니다.
- 이렇게 하면 서버는 lastEventId 보다 큰 이벤트만 전달 가능함을 보장할 수 있습니다.

event

- 이벤트의 타입을 표현하는 데에 사용됩니다.
- 정해진 것은 없고 위의 예제에서는 투표하는 경우를 예로 들어서 `vote` 로 지정해주었습니다.

data

- 이벤트가 가진 data 를 표현합니다.
- 만약 data 가 여러 줄로 표현되는 경우 new line (개행문자)로 구분해서 표현합니다.

retry

- 재접속(reconnection)을 위한 대기시간을 클라이언트에 전달할 때 사용하는 필드입니다.
- 밀리세컨드로 표현됩니다.
- 만약 문제가 생겨서 연결이 유실되면 retry 에 명시한 대기시간 만큼 대기한 후 재접속을 요청합니다.

comment

- 위에서는 `:election-event-k` 라고 표현된 필드입니다.
- 단순히 정보를 남기기 위해서 사용하는 필드입니다.

<br/>



## Spring 내에서의 상호작용

RequestMapping → HandlerMapping → HandlerMappingAdapter → ResultHandler(ResponseBodyResultHandler) 



## e.g.











